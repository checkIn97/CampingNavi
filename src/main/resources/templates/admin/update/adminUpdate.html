<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="/assets/css/main.css" rel="stylesheet"/>
    <link href="/assets/css/bg/mainBG.css" rel="stylesheet"/>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <title>CampNavi</title>
</head>
<style>
    body {
        display: flex;
        font-family: Arial, sans-serif; /* 폰트 설정 */
        line-height: 1.6; /* 줄 간격 */
    }
    .sidebar {
        width: 250px;
        height: 100vh;
        background-color: #343a40;
        padding: 20px;
    }
    .sidebar a {
        color: #ffffff;
        display: block;
        padding: 10px;
        text-decoration: none;
    }
    .sidebar a:hover {
        background-color: #495057;
    }
    .content {
        flex: 1;
        padding: 20px;
    }
    .page-index {
        padding: 20px;
    }
    .search-container {
        margin-bottom: 20px;
    }
    .table {
        width: 100%;
        margin-bottom: 20px;
    }
    .page-box {
        text-align: center;
    }
    .page-num {
        margin: 0 5px;
        cursor: pointer;
    }
    .page-num.active {
        font-weight: bold;
    }
    .icon {
        cursor: pointer;
    }
    .review-list-pop-back {
        background-color: #f8f9fa;
    }
    .popularPosts {
        font-weight: bold;
        color: #007bff;
    }
</style>
<body>
<div class="d-flex">
    <div class="sidebar">
        <a th:href="@{/admin/}"><h4 class="text-white">CampNavi Admin</h4></a>
        <a th:href="@{#}">데이터 관리</a>
        <a th:href="@{/admin/review/list}">리뷰 관리</a>
        <a th:href="@{/admin/member/list}">회원 관리</a>
        <a th:href="@{/admin/supervisor/list}">관리자 관리</a>
        <a href="/qna/home">관리자 문의</a>
        <a href="/oauth-login/member/logoutProc">로그아웃</a>
    </div>
</div>
<h2>캠핑장데이터</h2>
<div id="camp_ver"></div>
<div id="camp_update_progress"></div>
<button type="button" name="update_camp" id="update_camp">캠핑장데이터 업데이트</button>
<h2>추천모델</h2>
<div id="model_ver"></div>
<button type="button" name="update_model" id="update_model">추천모델 업데이트</button>
<h2>리뷰 크롤링</h2>
<div id="crawling_ver"></div>
<div id="crawling_progress"></div>
<button type="button" name="start_crawling" id="start_crawling">크롤링 시작하기</button>
<button type="button" name="resume_crawling" id="resume_crawling">크롤링 재개하기</button>
<button type="button" name="stop_crawling" id="stop_crawling">크롤링 일시정지</button>
</body>
<script>
    $(document).ready(function() {
        document.getElementById("update_camp").addEventListener("click", event => update_camp(event));
        document.getElementById("update_model").addEventListener("click", event => update_model(event));
        document.getElementById("start_crawling").addEventListener("click", event => start_crawling(event));
        document.getElementById("resume_crawling").addEventListener("click", event => resume_crawling(event));
        document.getElementById("stop_crawling").addEventListener("click", event => stop_crawling(event));
        load_update_history("camp");
        load_update_history("model");
        load_update_history("crawling");
    });

    function update_camp(event) {
        update("camp");
        event.preventDefault();
    }

    function update_model(event) {
        update("model");
        event.preventDefault();
    }

    function start_crawling(event) {
        review_crawling("start");
        event.preventDefault();
    }

    function resume_crawling(event) {
        review_crawling("resume");
        event.preventDefault();
    }

    function stop_crawling(event) {
        $.ajax({
            type: "POST",
            url: "/admin/crawling_stop",
            success: function(data) {
                if (data.result == 'success') {
                    alert("크롤링 중지");
                } else {
                    alert("크롤링 중지 실패");
                }
            },
            error: function() {
                alert("크롤링 중지 프로세스 오류");
            }
        });
        event.preventDefault();
    }

    /*
    function update0(kind) {
        if (kind == "camp") {
            alert("캠핑장데이터 업데이트 시작");
        } else {
            alert("추천모델 업데이트 시작");
        }
        $.ajax({
           type: "POST",
           url: "/admin/update",
           data: {
               kind: kind
           },
           success: function(data) {
               load_update_history(kind);
               if (data.result == 'success') {
                   if (kind == "camp") {
                       alert("작업 완료");
                   } else {
                       alert("작업 완료");
                   }
               } else {
                   if (kind == "camp") {
                       alert("작업 실패");
                   } else {
                       alert("작업 실패");
                   }
               }
           },
           error: function() {
               alert(kind + " 업데이트 중 오류 발생");
           }
        });
    }
    */

    function update(kind) {
        if (kind == "camp") {
            alert("캠핑장데이터 업데이트 시작");
            $.ajax({
                type: "POST",
                url: "/admin/get_totalCount",
                data: {
                    kind: kind
                },
                success: function(data0) {
                    if (data0.result == 'success') {
                        HTML = "";
                        HTML += "0\%";
                        $("#camp_update_progress").html(HTML);
                        let totalCount = data0.totalCount;
                        let size = 100;
                        let totalPage = parseInt((totalCount + size - 1) / size);
                        let count = 0;
                        for (let page = 1 ; page <= totalPage ; page++) {
                            $.ajax({
                                type: "POST",
                                url: "/admin/camping_data_search_from_api",
                                data: {
                                    kind: kind,
                                    page: page
                                },
                                success: function(data1) {
                                    if (data1.result == 'success') {
                                        count++;
                                        HTML = "";
                                        HTML += parseInt((count*100/totalPage)*0.90) + "\%";
                                        $("#camp_update_progress").html(HTML);
                                        if (count == totalPage) {
                                            $.ajax({
                                                type: "POST",
                                                url: "/admin/camping_data_integration",
                                                data: {
                                                    kind: kind,
                                                    totalPage: totalPage
                                                },
                                                success: function(data2) {
                                                    if (data2.result == 'success') {
                                                        HTML = "";
                                                        HTML += "99\%";
                                                        $("#camp_update_progress").html(HTML);
                                                        $.ajax({
                                                            type: "POST",
                                                            url: "/admin/camping_data_insert",
                                                            data: {
                                                                kind: kind
                                                            },
                                                            success: function(data3) {
                                                                if (data3.result == 'success') {
                                                                    HTML = "";
                                                                    HTML += "100\%";
                                                                    $("#camp_update_progress").html(HTML);
                                                                    load_update_history(kind);
                                                                    HTML = "";
                                                                    $("#camp_update_progress").html(HTML);
                                                                } else {
                                                                    alert("캠핑장데이터 최신화 오류");
                                                                    HTML = "";
                                                                    $("#camp_update_progress").html(HTML);
                                                                    load_update_history(kind);
                                                                }
                                                            },
                                                            error: function() {
                                                                alert("캠핑장데이터 최신화 오류");
                                                                HTML = "";
                                                                $("#camp_update_progress").html(HTML);
                                                                load_update_history(kind);
                                                            }
                                                        })
                                                    } else {
                                                        alert("캠핑장데이터 최신화 오류");
                                                        HTML = "";
                                                        $("#camp_update_progress").html(HTML);
                                                        load_update_history(kind);
                                                    }
                                                },
                                                error: function() {
                                                    alert("데이터 통합 실패");
                                                    HTML = "";
                                                    $("#camp_update_progress").html(HTML);
                                                    load_update_history(kind);
                                                }
                                            });
                                        }
                                    } else {
                                        alert("캠핑장 데이터 가져오기 실패");
                                        location.reload();
                                    }
                                },
                                error: function() {
                                    alert("캠핑장 데이터 가져오기 실패");
                                    location.reload();
                                }
                            });
                        }
                    } else {
                        alert("totalCount 가져오기 실패");
                        HTML = "";
                        $("#camp_update_progress").html(HTML);
                        load_update_history(kind);
                    }
                },
                error: function() {
                    alert(kind + " 업데이트 중 오류 발생");
                    HTML = "";
                    $("#camp_update_progress").html(HTML);
                    load_update_history(kind);
                }
            });
        } else {
            alert("추천모델 업데이트 시작");
            $.ajax({
                type: "POST",
                url: "/admin/update",
                data: {
                    kind: kind
                },
                success: function(data) {
                    if (data.result == 'success') {
                        alert("작업 완료");
                        load_update_history(kind);
                    } else {
                        alert("작업 실패");
                        load_update_history(kind);
                    }
                },
                error: function() {
                    alert(kind + " 업데이트 중 오류 발생");
                    load_update_history(kind);
                }
            });
        }
    }

    function check_file_exist(file_name) {
        check_value = false;
        $.ajax({
            type: "POST",
            url: "/admin/check_file_exist",
            data: {
                filename: file_name
            },
            success: function(data) {
                check_value = data.result;
            },
            error: function() {
                alert("파일 유무 확인 실패");
            }
        });
        return check_value;
    }


    function load_update_history(kind) {
        $.ajax({
            type: 'POST',
            url: '/admin/load_update_history',
            data: {
                kind: kind
            },
            success: function(data) {
                let updateTime = data.updateTime;
                let updateTry = data.updateTry;
                let totalCount = data.totalCount;
                let result = data.result;
                HTML = "";
                if (kind == "camp") {
                    HTML += "<h3>현재 버전 : " + updateTime + " (" + totalCount + "개)</h3>";
                } else {
                    HTML += "<h3>현재 버전 : " + updateTime + "</h3>";
                }
                HTML += "<h3>갱신 시도 : " + updateTry + " " + result + "</h3>";
                if (kind == 'camp') {
                    $("#camp_ver").html(HTML);
                } else if (kind == 'model') {
                    $("#model_ver").html(HTML);
                } else {
                    $("#crawling_ver").html(HTML);
                }
            },
            error: function() {
                alert(kind + " 로그 데이터 가져오기 실패");
            }
        });
    }

    function review_crawling(update_type) {
        alert("리뷰 크롤링 시작");
        $.ajax({
            type: "POST",
            url: "/admin/get_crawling_initialize", // 크롤링 동작 유형 확인 (처음부터, 이어서)
            data: {
                update_type: update_type
            },
            success: function(data0) {
                if (data0.result != 'fail') {
                    HTML = "";
                    $("#crawling_progress").html(HTML);
                    $.ajax({
                        type: "POST",
                        url: "/admin/get_crawling_data",
                        success: function(data1) {
                            if (data1.result == 'success') {
                                count++;
                                HTML = "";
                                $("#crawling_progress").html(HTML);
                                $.ajax({
                                    type: "POST",
                                    url: "/admin/crawling_data_integration", // 크롤링 완료시 파일 통합
                                    success: function(data2) {
                                        alert("크롤링 완료");
                                        load_update_history(kind);
                                    },
                                    error: function() {
                                        alert("데이터 통합 실패");
                                        HTML = "";
                                        $("#crawling_progress").html(HTML);
                                        load_update_history(kind);
                                    }
                                });
                            } else if (data1.result == 'stopped') {
                                alert("크롤링 중지 완료");
                            } else {
                                alert("크롤링 중 오류 발생");
                                location.reload();
                            }
                        },
                        error: function() {
                            alert("크롤링 중 오류 발생");
                            location.reload();
                        }
                    });
                } else {
                    alert("초기화 실패");
                    HTML = "";
                    $("#crawling_progress").html(HTML);
                    load_update_history(kind);
                }
            },
            error: function() {
                alert("크롤링 중 오류 발생");
                HTML = "";
                $("#crawling_progress").html(HTML);
                load_update_history(kind);
            }
        });
    }



</script>
</html>