<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <link href="/assets/css/main.css" rel="stylesheet"/>
    <link href="/assets/css/bg/loginBG.css" rel="stylesheet"/>
    <title>회원가입</title>
</head>
<style>
    /* 모달 창 스타일 */
    .modal {
        display: none; /* 초기에는 숨김 */
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
<body>

<a href="/member/login"><img alt="typo" id="typo" th:src="@{/assets/images/logo/typo.png}"></a>
<script th:inline="javascript">
    $(document).ready(function() {
        $('#submitBtn').prop('disabled', true); // 초기에 회원가입 버튼 비활성화
    });

    function validatePW() {
        var op = $("#originpw").val();
        var cp = $("#pwcheck").val();
        if(op===cp) {
            alert("비밀번호가 일치합니다.");
            $('#submitBtn').prop('disabled', false);
        } else {
            alert("비밀번호가 일치하지 않습니다.");
            $("#pwcheck").val("");
            $('#submitBtn').prop('disabled', true);
            op.focus();
        }
    }

    function validateId() {
        var username = $("#userId").val();

        $.ajax({
            type: 'POST',
            url: '/member/validateUser',
            data: {
                username: username
            },
            success: function(data) {
                var result = data.result;
                if(result === "success") {
                    alert("사용 가능한 아이디 입니다.")
                    $('#submitBtn').prop('disabled', false);
                } else {
                    alert("이미 존재하는 아이디 입니다.")
                    $('#submitBtn').prop('disabled', true);
                    $("#userId").focus()
                }

            },
            error: function (error) {
                alert("전송 실패")
            }
        })
    }

    function validateNickname() {
        var nickname = $("#nickname").val();

        $.ajax({
            type: 'POST',
            url: '/member/validateNickname',
            data: {
                nickname: nickname
            },
            success: function(data) {
                var result = data.result;
                if(result === "success") {
                    alert("사용 가능한 닉네임 입니다.")
                    $('#submitBtn').prop('disabled', false);
                } else {
                    alert("이미 존재하는 닉네임 입니다.")
                    $('#submitBtn').prop('disabled', true);
                    $("#nickname").focus()
                }

            },
            error: function (error) {
                alert("전송 실패")
            }
        })
    }

    function sendNumber() {
        $.ajax({
            url: "/mailSend",
            type: "POST",
            dataType: "json",
            data: {
                mail : $("#email").val()
            },
            success: function (data) {
                alert("인증번호 발송");
                openModal(); // 모달 창 열기
            },
            error: function (error) {
                alert("인증번호 전송실패");
            }
        });
    }

    // 모달 열기
    function openModal() {
        var modal = document.getElementById('verificationModal');
        modal.style.display = 'block';
    }

    // 모달 닫기
    function closeModal() {
        var modal = document.getElementById('verificationModal');
        modal.style.display = 'none';
    }

    // 인증 코드 확인 처리
    function checkVerificationCode() {
        var verificationCode = $('#verificationCodeInput').val();
        $.ajax({
            url: "/mailCheck",
            type: "GET",
            data: {
                userNumber: verificationCode
            },
            success: function (response) {
                if(response === true) {
                    alert("인증에 성공하셨습니다.");
                    $('#submitBtn').prop('disabled', false);
                    closeModal(); // 인증 성공 후 모달 닫기
                } else {
                    alert("인증번호가 일치하지 않습니다.");
                    $('#submitBtn').prop('disabled', true);
                }
            },
            error: function (error) {
                alert("인증사실 전송실패");
            }
        });
    }

    function searchAddress() {
        var postcodePopup = new daum.Postcode({
            oncomplete: function(data) {
                // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                var roadAddr = data.roadAddress; // 도로명 주소 변수
                var extraRoadAddr = ''; // 참고 항목 변수

                // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                    extraRoadAddr += data.bname;
                }
                // 건물명이 있고, 공동주택일 경우 추가한다.
                if(data.buildingName !== '' && data.apartment === 'Y'){
                    extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                if(extraRoadAddr !== ''){
                    extraRoadAddr = ' (' + extraRoadAddr + ')';
                }

                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                document.getElementById("addr").value = roadAddr;
                setTimeout(function() {
                    postcodePopup.close();
                }, 0);
            }
        });
        postcodePopup.open();

    }

    function submitProc() {
        var username = $("#userId").val();
        var password = $("#originpw").val();
        var name = $("#name").val();
        var nickname = $("#nickname").val();
        var birth = $("#birth").val();
        var phone = $("#phone").val();
        var email = $("#email").val();
        var addr = $("#addr").val();

        if (username == "") {
            alert("아이디를 입력해주세요!");
            $("#userId").focus();
        } else if (password == "") {
            alert("비밀번호를 입력해주세요!");
            $("#originpw").focus();
        } else if (name == "") {
            alert("이름을 입력해주세요!");
            $("#name").focus()
        } else if (nickname == "") {
            alert("사이트에서 사용할 닉네임을 입력해주세요!");
            $("#nickname").focus()
        } else if (birth == "") {
            alert("생일을 입력해주세요!");
        } else if (phone == "") {
            alert("전화번호를 입력해주세요!");
            $("#phone").focus()
        } else if (email == "") {
            alert("이메일을 입력해주세요!");
            $("#email").focus()
        } else if (addr == ""){
            alert("주소를 입력해주세요!");
            $("#addr").focus();
        } else {
            $("#joinForm").attr("action", "/member/joinProc").submit();
        }

    }
</script>


<div class="box" id="membershipBox">
    <h1 class="major">회원가입</h1>
    <div id="membershipContain">
        <form action="/member/joinProc" method="post" name="joinForm" id="joinForm">
            <div class="memberContain">
                <input placeholder="아이디" type="text" name="username" id="userId">
                <button type="button" onclick="validateId()">id 중복 확인</button>
            </div>

            <div class="memberContain">
                <div class="buttonContain">
                    <input placeholder="비밀번호" type="password" name="pw" id="originpw">
                    <input placeholder="비밀번호 확인" type="password" id="pwcheck">
                </div>
                <button type="button" onclick="validatePW()">비밀번호 중복 확인</button>
            </div>

            <div class="memberContain">
                <input placeholder="이름" type="text" name="name" id="name">
            </div>

            <div class="memberContain">
                <input type="radio" id="male" name="sex" th:value="m" checked>남
                <input type="radio" id="female" name="sex" th:value="f">여
            </div>

            <div class="memberContain">
                <input placeholder="닉네임" type="text" name="nickname" id="nickname">
                <button type="button" onclick="validateNickname()">닉네임 중복 확인</button>
            </div>

            <div class="memberContain">
                <input placeholder="생년월일" type="date" name="birth" id="birth">
            </div>

            <div class="memberContain">
                <input placeholder="전화번호" type="tel" name="phone" id="phone">
                <!--<button type="button">핸드폰 번호 인증</button>-->
            </div>

            <div class="memberContain">
                <input placeholder="이메일" type="email" name="email" id="email">
                <button type="button" onclick="sendNumber()">이메일 인증</button>
            </div>

            <div class="memberContain">
                <input placeholder="주소" type="text" name="addr" id="addr" readonly>
                <button type="button" onclick="searchAddress()">주소 검색</button>
            </div>

            <button class="mainBtn" type="button" id="submitBtn" onclick="submitProc()">회원가입</button>
        </form>
    </div>
</div>

<th:block th:insert="insert/footer.html"></th:block>
<!--배경사진-->
<div id="bg"></div>
<!-- 모달 창 -->
<div id="verificationModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <p>인증번호를 입력하세요:</p>
        <input type="text" id="verificationCodeInput">
        <button onclick="checkVerificationCode()">확인</button>
    </div>
</div>
</body>
</html>